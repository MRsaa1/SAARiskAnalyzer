#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ backend..."
echo ""

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç
echo "1Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è—é —á—Ç–æ backend —Ä–∞–±–æ—Ç–∞–µ—Ç..."
if curl -s http://localhost:8084/api/dashboard > /dev/null; then
    echo "   ‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "   ‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    exit 1
fi

# 2. –ü–æ–ª—É—á–∞–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞
PID=$(lsof -ti:8084)
echo "2Ô∏è‚É£ PID backend –ø—Ä–æ—Ü–µ—Å—Å–∞: $PID"

# 3. –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å
echo "3Ô∏è‚É£ –£–±–∏–≤–∞—é –ø—Ä–æ—Ü–µ—Å—Å..."
kill -9 $PID
echo "   ‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —É–±–∏—Ç"

# 4. –ñ–¥–µ–º 15 —Å–µ–∫—É–Ω–¥ (ThrottleInterval = 10 —Å–µ–∫—É–Ω–¥ + –∑–∞–ø–∞—Å)
echo "4Ô∏è‚É£ –ñ–¥—É 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞..."
for i in {15..1}; do
    echo -ne "   ‚è≥ $i —Å–µ–∫...\r"
    sleep 1
done
echo ""

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ backend —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
echo "5Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è—é —á—Ç–æ backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è..."
sleep 2
if curl -s http://localhost:8084/api/dashboard > /dev/null; then
    NEW_PID=$(lsof -ti:8084)
    echo "   ‚úÖ Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è!"
    echo "   üìù –ù–æ–≤—ã–π PID: $NEW_PID"
    echo ""
    echo "üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω! Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏."
else
    echo "   ‚ùå Backend –Ω–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    echo "   üîç –ü—Ä–æ–≤–µ—Ä—è—é –ª–æ–≥–∏..."
    tail -20 ~/saa-risk-analyzer/backend_error.log
    exit 1
fi

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ
echo ""
echo "6Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è—é —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã..."
curl -s http://localhost:8084/api/dashboard | jq '.' 2>/dev/null || curl -s http://localhost:8084/api/dashboard
echo ""
echo "‚úÖ –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!"

